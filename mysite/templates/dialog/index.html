{% load static %}
<!DOCTYPE html>
<html>

  <head>
    <title>Hongik-gpt</title>
    <link rel="stylesheet" type="text/css" href="{% static 'style.css' %}">
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        document
          .getElementById('question')
          .addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
              event.preventDefault();
              askQuestion();
            }
          });
      });

      function addMessage(sender, message) {
        var chatBox = document.getElementById('chat-box');
        var messageDiv = document.createElement('div');
        messageDiv.innerHTML = `<p><strong>${sender}:</strong> ${message}</p>`;
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function askQuestion() {
        var question = document
          .getElementById('question')
          .value;
        fetch('/dialog/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: new URLSearchParams({'question': question})
        })
          .then(response => response.json())
          .then(data => {
            var chatBox = document.getElementById('chat-box');

            addMessage('You', question);
            if (question === "총장님") {
              var buttonDiv = document.createElement('div');
              buttonDiv.innerHTML = `<button onclick="handleButtonClick('옵션1')">옵션1</button> <button onclick="handleButtonClick('옵션2')">옵션2</button>`;
              chatBox.appendChild(buttonDiv);
            } else {
              addMessage('Bot', data.answer);
            }

            chatBox.scrollTop = chatBox.scrollHeight;
            document
              .getElementById('question')
              .value = '';
          })
          .catch(error => {
            console.error('Error:', error);
          });
      }

      function handleButtonClick(option) {
        addMessage('You', option);
        fetch('/dialog/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: new URLSearchParams({'question': option})
        })
          .then(response => response.json())
          .then(data => {
            addMessage('Bot', data.answer);
          })
          .catch(error => {
            console.error('Error:', error);
          });
      }
    </script>
  </head>

  <body>
    <div>
      {% if user.is_authenticated%}
        <a href="{%url 'common:logout'%}">{{user.username}}
          (로그아웃)</a>
        {%else%}
        <div>로그인 안되어있음</div>
        {%endif%}
      </div>
      <div id="chat-container">
        <h1>Hongik-gpt</h1>
        <div id="chat-box">
          {% for message in messages %}
            <p>{{ message.message }}</p>
          {% endfor %}
        </div>
        <input type="text" id="question" placeholder="Ask a question">
        <button id="ask-button" onclick="askQuestion()">Ask</button>
      </div>
    </body>

  </html>
